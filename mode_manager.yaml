blueprint:
  name: Mode Manager (Hubitat Style) v1.0.6
  description: |
    Comprehensive mode management system that replicates Hubitat Mode Manager functionality (v1.0.6).
    Automatically changes modes based on time, presence, buttons, and switches using an input_select entity.
    Supports sunrise/sunset triggers, presence detection, button events, and switch states.
  domain: automation
  homeassistant:
    min_version: 2024.6.0
  input:
    # ==========================================
    # BASIC CONFIGURATION
    # ==========================================
    mode_selector:
      name: Mode Input Select Entity
      description: Select the input_select entity that will store the current mode
      selector:
        entity:
          domain: input_select
    
    time_modes_section:
      name: "â° Time-Based Mode Changes"
      icon: mdi:clock-outline
      description: "Configure automatic mode changes based on time, sunrise/sunset"
      collapsed: false
      input:
        enable_time_modes:
          name: Enable Time-Based Mode Changes
          description: Enable automatic mode changes based on time
          default: true
          selector:
            boolean: {}
        
        # Morning/Day Mode Settings
        enable_morning_mode:
          name: "Enable Day Mode"
          description: "Enable automatic Day mode changes"
          default: true
          selector:
            boolean: {}
        
        morning_mode:
          name: "Day Mode"
          description: "Enter the mode name from your input_select to set during daytime (e.g., 'Day', 'Morning')"
          default: "Day"
          selector:
            text: {}
    
        morning_trigger_type:
          name: "Day Mode Trigger"
          description: "How to trigger Day mode"
          default: "time"
          selector:
            select:
              options:
                - label: "Fixed Time"
                  value: "time"
                - label: "Sunrise (with optional offset)"
                  value: "sunrise"
                - label: "Earlier of Fixed Time or Sunrise"
                  value: "earlier"
                - label: "Later of Fixed Time or Sunrise"
                  value: "later"
    
        morning_time:
          name: "Day Mode - Fixed Time"
          description: "Fixed time to switch to Day mode"
          default: "07:00:00"
          selector:
            time: {}
    
        sunrise_offset:
          name: "Day Mode - Sunrise Offset"
          description: "Time before (-) or after (+) sunrise"
          default: { minutes: 0 }
          selector:
            duration:
              negative: true
    
        morning_schedule_type:
          name: "Day Mode - Schedule Type"
          description: "Choose how to control when Day mode is triggered"
          default: "all_days"
          selector:
            select:
              options:
                - label: "All Days"
                  value: "all_days"
                - label: "Select Specific Days"
                  value: "specific_days"
                - label: "Use Schedule Helper"
                  value: "schedule_helper"
    
        morning_days:
          name: "Day Mode - Days of Week"
          description: "Select days when Day mode should be triggered (only used if 'Select Specific Days' chosen above)"
          default: []
          selector:
            select:
              options:
                - label: "Monday"
                  value: "monday"
                - label: "Tuesday"
                  value: "tuesday"
                - label: "Wednesday"
                  value: "wednesday"
                - label: "Thursday"
                  value: "thursday"
                - label: "Friday"
                  value: "friday"
                - label: "Saturday"
                  value: "saturday"
                - label: "Sunday"
                  value: "sunday"
              multiple: true
    
        morning_schedule:
          name: "Day Mode - Schedule Helper"
          description: "Select a schedule helper entity (only used if 'Use Schedule Helper' chosen above)"
          default: ""
          selector:
            entity:
              domain: schedule
              multiple: false
    
        # Evening Mode Settings
        enable_evening_mode:
          name: "Enable Evening Mode"
          description: "Enable automatic Evening mode changes"
          default: true
          selector:
            boolean: {}
    
        evening_mode:
          name: "Evening Mode"
          description: "Enter the mode name from your input_select to set during evening (e.g., 'Evening', 'Dusk')"
          default: "Evening"
          selector:
            text: {}
    
        evening_trigger_type:
          name: "Evening Mode Trigger"
          description: "How to trigger Evening mode"
          default: "time"
          selector:
            select:
              options:
                - label: "Fixed Time"
                  value: "time"
                - label: "Sunset (with optional offset)"
                  value: "sunset"
                - label: "Earlier of Fixed Time or Sunset"
                  value: "earlier"
                - label: "Later of Fixed Time or Sunset"
                  value: "later"
    
        evening_time:
          name: "Evening Mode - Fixed Time"
          description: "Fixed time to switch to Evening mode"
          default: "18:00:00"
          selector:
            time: {}
    
        sunset_offset:
          name: "Evening Mode - Sunset Offset"
          description: "Time before (-) or after (+) sunset"
          default: { minutes: 0 }
          selector:
            duration:
              negative: true
    
        evening_schedule_type:
          name: "Evening Mode - Schedule Type"
          description: "Choose how to control when Evening mode is triggered"
          default: "all_days"
          selector:
            select:
              options:
                - label: "All Days"
                  value: "all_days"
                - label: "Select Specific Days"
                  value: "specific_days"
                - label: "Use Schedule Helper"
                  value: "schedule_helper"
    
        evening_days:
          name: "Evening Mode - Days of Week"
          description: "Select days when Evening mode should be triggered (only used if 'Select Specific Days' chosen above)"
          default: []
          selector:
            select:
              options:
                - label: "Monday"
                  value: "monday"
                - label: "Tuesday"
                  value: "tuesday"
                - label: "Wednesday"
                  value: "wednesday"
                - label: "Thursday"
                  value: "thursday"
                - label: "Friday"
                  value: "friday"
                - label: "Saturday"
                  value: "saturday"
                - label: "Sunday"
                  value: "sunday"
              multiple: true
    
        evening_schedule:
          name: "Evening Mode - Schedule Helper"
          description: "Select a schedule helper entity (only used if 'Use Schedule Helper' chosen above)"
          default: ""
          selector:
            entity:
              domain: schedule
              multiple: false
    
        # Night Mode Settings
        enable_night_mode:
          name: "Enable Night Mode"
          description: "Enable automatic Night mode changes"
          default: true
          selector:
            boolean: {}
    
        night_mode:
          name: "Night Mode"
          description: "Enter the mode name from your input_select to set at night (e.g., 'Night', 'Sleep')"
          default: "Night"
          selector:
            text: {}
    
        night_trigger_type:
          name: "Night Mode Trigger"
          description: "How to trigger Night mode"
          default: "time"
          selector:
            select:
              options:
                - label: "Fixed Time"
                  value: "time"
                - label: "Sunset (with optional offset)"
                  value: "sunset"
                - label: "Earlier of Fixed Time or Sunset"
                  value: "earlier"
                - label: "Later of Fixed Time or Sunset"
                  value: "later"
    
        night_time:
          name: "Night Mode - Fixed Time"
          description: "Fixed time to switch to Night mode"
          default: "22:00:00"
          selector:
            time: {}
    
        night_sunset_offset:
          name: "Night Mode - Sunset Offset"
          description: "Time before (-) or after (+) sunset for Night mode"
          default: { minutes: 240 }
          selector:
            duration:
              negative: true
    
        night_schedule_type:
          name: "Night Mode - Schedule Type"
          description: "Choose how to control when Night mode is triggered"
          default: "all_days"
          selector:
            select:
              options:
                - label: "All Days"
                  value: "all_days"
                - label: "Select Specific Days"
                  value: "specific_days"
                - label: "Use Schedule Helper"
                  value: "schedule_helper"
    
        night_days:
          name: "Night Mode - Days of Week"
          description: "Select days when Night mode should be triggered (only used if 'Select Specific Days' chosen above)"
          default: []
          selector:
            select:
              options:
                - label: "Monday"
                  value: "monday"
                - label: "Tuesday"
                  value: "tuesday"
                - label: "Wednesday"
                  value: "wednesday"
                - label: "Thursday"
                  value: "thursday"
                - label: "Friday"
                  value: "friday"
                - label: "Saturday"
                  value: "saturday"
                - label: "Sunday"
                  value: "sunday"
              multiple: true
    
        night_schedule:
          name: "Night Mode - Schedule Helper"
          description: "Select a schedule helper entity (only used if 'Use Schedule Helper' chosen above)"
          default: ""
          selector:
            entity:
              domain: schedule
              multiple: false
    
        skip_time_modes:
          name: Skip Time Changes for These Modes
          description: Comma-separated list of modes that should not be changed by time-based triggers (e.g., "Away,Vacation,Party")
          default: "Away"
          selector:
            text: {}
    
        set_mode_on_startup:
          name: Set Mode on System Startup
          description: Set mode based on time table when Home Assistant starts
          default: false
          selector:
            boolean: {}
    
    presence_section:
      name: "ðŸ‘¥ Presence-Based Mode Changes"
      icon: mdi:account-multiple
      description: "Configure automatic away/home mode changes based on presence detection"
      collapsed: true
      input:
        enable_presence_modes:
          name: Enable Presence-Based Mode Changes
          description: Enable automatic mode changes based on presence
          default: false
          selector:
            boolean: {}
    
        presence_trackers:
          name: Device Trackers / Person Entities
          description: Select device tracker or person entities for presence detection
          default: []
          selector:
            entity:
              domain:
                - person
                - device_tracker
              multiple: true
    
        away_trigger_logic:
          name: Away Mode Trigger Logic
          description: When to trigger Away mode
          default: "all_away"
          selector:
            select:
              options:
                - label: "When ALL selected people/devices are away"
                  value: "all_away"
                - label: "When ANY selected person/device leaves"
                  value: "any_away"
    
        away_mode:
          name: Away Mode
          description: Enter the mode name from your input_select to set when away condition is met (e.g., 'Away', 'Vacation')
          default: "Away"
          selector:
            text: {}
    
        return_trigger_logic:
          name: Return Trigger Logic
          description: When to trigger return from Away mode
          default: "any_home"
          selector:
            select:
              options:
                - label: "When ANY selected person/device returns home"
                  value: "any_home"
                - label: "When ALL selected people/devices are home"
                  value: "all_home"
    
        return_from_away_mode:
          name: Return from Away Behavior
          description: How to handle returning from away mode
          default: "time_based"
          selector:
            select:
              options:
                - label: "Use time-based mode (recommended)"
                  value: "time_based"
                - label: "Use specific mode"
                  value: "specific"
    
        return_mode:
          name: Return Mode
          description: Enter the mode name from your input_select to set when returning (if not using time-based, e.g., 'Day')
          default: "Day"
          selector:
            text: {}
    
    # ==========================================
    # ðŸ  GUEST MODE
    # ==========================================
    guest_mode_sensor:
      name: Guest Mode Sensor (Optional)
      description: Binary sensor that indicates when guests are present (prevents away mode when 'on'). Leave empty to disable guest mode.
      default: ""
      selector:
        entity:
          domain: 
            - binary_sensor
            - input_boolean
            - switch
    

variables:
  mode_entity: !input mode_selector
  skip_modes: !input skip_time_modes
  current_mode: "{{ states(mode_entity) }}"
  skip_mode_list: "{{ skip_modes.split(',') | map('trim') | list if skip_modes else [] }}"
  morning_trigger_type: !input morning_trigger_type
  evening_trigger_type: !input evening_trigger_type
  night_trigger_type: !input night_trigger_type
  enable_time_modes: !input enable_time_modes
  enable_morning_mode: !input enable_morning_mode
  enable_evening_mode: !input enable_evening_mode
  enable_night_mode: !input enable_night_mode
  enable_presence_modes: !input enable_presence_modes
  morning_time: !input morning_time
  evening_time: !input evening_time
  sunrise_offset: !input sunrise_offset
  sunset_offset: !input sunset_offset
  presence_trackers: !input presence_trackers
  away_trigger_logic: !input away_trigger_logic
  return_trigger_logic: !input return_trigger_logic
  away_mode: !input away_mode
  morning_mode: !input morning_mode
  evening_mode: !input evening_mode
  night_mode: !input night_mode
  return_mode: !input return_mode
  morning_schedule_type: !input morning_schedule_type
  morning_days: !input morning_days
  morning_schedule: !input morning_schedule
  evening_schedule_type: !input evening_schedule_type
  evening_days: !input evening_days
  evening_schedule: !input evening_schedule
  night_schedule_type: !input night_schedule_type
  night_days: !input night_days
  night_schedule: !input night_schedule
  night_time: !input night_time
  night_sunset_offset: !input night_sunset_offset
  current_weekday: "{{ now().strftime('%A').lower() }}"
  guest_mode_sensor: !input guest_mode_sensor

trigger:
  # Day Mode triggers
  - platform: time
    at: !input morning_time
    id: "morning_time"
    enabled: "{{ enable_time_modes and enable_morning_mode and morning_trigger_type in ['time', 'earlier', 'later'] }}"
  
  - platform: sun
    event: sunrise
    offset: !input sunrise_offset
    id: "sunrise"
    enabled: "{{ enable_time_modes and enable_morning_mode and morning_trigger_type in ['sunrise', 'earlier', 'later'] }}"
  
  # Evening Mode triggers
  - platform: time
    at: !input evening_time
    id: "evening_time"
    enabled: "{{ enable_time_modes and enable_evening_mode and evening_trigger_type in ['time', 'earlier', 'later'] }}"
  
  - platform: sun
    event: sunset
    offset: !input sunset_offset
    id: "sunset"
    enabled: "{{ enable_time_modes and enable_evening_mode and evening_trigger_type in ['sunset', 'earlier', 'later'] }}"
  
  # Night Mode triggers
  - platform: time
    at: !input night_time
    id: "night_time"
    enabled: "{{ enable_time_modes and enable_night_mode and night_trigger_type in ['time', 'earlier', 'later'] }}"
  
  - platform: sun
    event: sunset
    offset: !input night_sunset_offset
    id: "night_sunset"
    enabled: "{{ enable_time_modes and enable_night_mode and night_trigger_type in ['sunset', 'earlier', 'later'] }}"
  
  # Presence triggers
  - platform: state
    entity_id: !input presence_trackers
    from: "home"
    id: "presence_away"
    enabled: "{{ enable_presence_modes and presence_trackers | default([]) | length > 0 }}"
  
  - platform: state
    entity_id: !input presence_trackers
    to: "home"
    id: "presence_home"
    enabled: "{{ enable_presence_modes and presence_trackers | default([]) | length > 0 }}"
  
  
  # Startup trigger
  - platform: homeassistant
    event: start
    id: "startup"
    enabled: !input set_mode_on_startup

condition: []

action:
  - choose:
      # Day Mode time-based changes
      - conditions:
          - condition: trigger
            id: 
              - "morning_time"
              - "sunrise"
          - condition: template
            value_template: "{{ enable_morning_mode }}"
          - condition: template
            value_template: "{{ current_mode not in skip_mode_list }}"
          - condition: template
            value_template: >
              {% set schedule_type = morning_schedule_type %}
              {% if schedule_type == 'all_days' %}
                true
              {% elif schedule_type == 'specific_days' %}
                {% set days = morning_days %}
                {% set weekday = current_weekday %}
                {{ days | length == 0 or weekday in days }}
              {% elif schedule_type == 'schedule_helper' %}
                {% set schedule_entity = morning_schedule %}
                {{ schedule_entity == '' or is_state(schedule_entity, 'on') }}
              {% else %}
                true
              {% endif %}
          - condition: template
            value_template: >
              {% set trigger_type = morning_trigger_type %}
              {% set trigger_id = trigger.id %}
              {% if trigger_type == 'time' %}
                {{ trigger_id == 'morning_time' }}
              {% elif trigger_type == 'sunrise' %}
                {{ trigger_id == 'sunrise' }}
              {% elif trigger_type == 'earlier' %}
                {% set fixed_time = today_at(morning_time) %}
                {% set sunrise_time = as_datetime(state_attr('sun.sun', 'next_rising')) + timedelta(minutes=sunrise_offset) %}
                {% if trigger_id == 'morning_time' %}
                  {{ fixed_time <= sunrise_time }}
                {% elif trigger_id == 'sunrise' %}
                  {{ sunrise_time <= fixed_time }}
                {% endif %}
              {% elif trigger_type == 'later' %}
                {% set fixed_time = today_at(morning_time) %}
                {% set sunrise_time = as_datetime(state_attr('sun.sun', 'next_rising')) + timedelta(minutes=sunrise_offset) %}
                {% if trigger_id == 'morning_time' %}
                  {{ fixed_time >= sunrise_time }}
                {% elif trigger_id == 'sunrise' %}
                  {{ sunrise_time >= fixed_time }}
                {% endif %}
              {% endif %}
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input mode_selector
            data:
              option: !input morning_mode
      
      # Evening Mode time-based changes
      - conditions:
          - condition: trigger
            id: 
              - "evening_time"
              - "sunset"
          - condition: template
            value_template: "{{ enable_evening_mode }}"
          - condition: template
            value_template: "{{ current_mode not in skip_mode_list }}"
          - condition: template
            value_template: >
              {% set schedule_type = evening_schedule_type %}
              {% if schedule_type == 'all_days' %}
                true
              {% elif schedule_type == 'specific_days' %}
                {% set days = evening_days %}
                {% set weekday = current_weekday %}
                {{ days | length == 0 or weekday in days }}
              {% elif schedule_type == 'schedule_helper' %}
                {% set schedule_entity = evening_schedule %}
                {{ schedule_entity == '' or is_state(schedule_entity, 'on') }}
              {% else %}
                true
              {% endif %}
          - condition: template
            value_template: >
              {% set trigger_type = evening_trigger_type %}
              {% set trigger_id = trigger.id %}
              {% if trigger_type == 'time' %}
                {{ trigger_id == 'evening_time' }}
              {% elif trigger_type == 'sunset' %}
                {{ trigger_id == 'sunset' }}
              {% elif trigger_type == 'earlier' %}
                {% set fixed_time = today_at(evening_time) %}
                {% set sunset_time = as_datetime(state_attr('sun.sun', 'next_setting')) + timedelta(minutes=sunset_offset) %}
                {% if trigger_id == 'evening_time' %}
                  {{ fixed_time <= sunset_time }}
                {% elif trigger_id == 'sunset' %}
                  {{ sunset_time <= fixed_time }}
                {% endif %}
              {% elif trigger_type == 'later' %}
                {% set fixed_time = today_at(evening_time) %}
                {% set sunset_time = as_datetime(state_attr('sun.sun', 'next_setting')) + timedelta(minutes=sunset_offset) %}
                {% if trigger_id == 'evening_time' %}
                  {{ fixed_time >= sunset_time }}
                {% elif trigger_id == 'sunset' %}
                  {{ sunset_time >= fixed_time }}
                {% endif %}
              {% endif %}
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input mode_selector
            data:
              option: !input evening_mode
      
      # Night Mode time-based changes
      - conditions:
          - condition: trigger
            id: 
              - "night_time"
              - "night_sunset"
          - condition: template
            value_template: "{{ enable_night_mode }}"
          - condition: template
            value_template: "{{ current_mode not in skip_mode_list }}"
          - condition: template
            value_template: >
              {% set schedule_type = night_schedule_type %}
              {% if schedule_type == 'all_days' %}
                true
              {% elif schedule_type == 'specific_days' %}
                {% set days = night_days %}
                {% set weekday = current_weekday %}
                {{ days | length == 0 or weekday in days }}
              {% elif schedule_type == 'schedule_helper' %}
                {% set schedule_entity = night_schedule %}
                {{ schedule_entity == '' or is_state(schedule_entity, 'on') }}
              {% else %}
                true
              {% endif %}
          - condition: template
            value_template: >
              {% set trigger_type = night_trigger_type %}
              {% set trigger_id = trigger.id %}
              {% if trigger_type == 'time' %}
                {{ trigger_id == 'night_time' }}
              {% elif trigger_type == 'sunset' %}
                {{ trigger_id == 'night_sunset' }}
              {% elif trigger_type == 'earlier' %}
                {% set fixed_time = today_at(night_time) %}
                {% set sunset_time = as_datetime(state_attr('sun.sun', 'next_setting')) + timedelta(minutes=night_sunset_offset) %}
                {% if trigger_id == 'night_time' %}
                  {{ fixed_time <= sunset_time }}
                {% elif trigger_id == 'night_sunset' %}
                  {{ sunset_time <= fixed_time }}
                {% endif %}
              {% elif trigger_type == 'later' %}
                {% set fixed_time = today_at(night_time) %}
                {% set sunset_time = as_datetime(state_attr('sun.sun', 'next_setting')) + timedelta(minutes=night_sunset_offset) %}
                {% if trigger_id == 'night_time' %}
                  {{ fixed_time >= sunset_time }}
                {% elif trigger_id == 'night_sunset' %}
                  {{ sunset_time >= fixed_time }}
                {% endif %}
              {% else %}
                true
              {% endif %}
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input mode_selector
            data:
              option: !input night_mode
      
      # Presence-based mode changes - Away
      - conditions:
          - condition: trigger
            id: "presence_away"
          - condition: template
            value_template: >
              {% set trackers = presence_trackers %}
              {% set logic = away_trigger_logic %}
              {% if trackers %}
                {% if logic == 'all_away' %}
                  {{ expand(trackers) | selectattr('state', 'eq', 'home') | list | length == 0 }}
                {% elif logic == 'any_away' %}
                  {{ expand(trackers) | selectattr('state', 'ne', 'home') | list | length > 0 }}
                {% else %}
                  false
                {% endif %}
              {% else %}
                false
              {% endif %}
          - condition: template
            value_template: >
              {% set guest_sensor = guest_mode_sensor %}
              {% if guest_sensor != '' %}
                {{ not is_state(guest_sensor, 'on') }}
              {% else %}
                true
              {% endif %}
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input mode_selector
            data:
              option: !input away_mode
      
      # Presence-based mode changes - Return Home
      - conditions:
          - condition: trigger
            id: "presence_home"
          - condition: template
            value_template: "{{ current_mode == away_mode }}"
          - condition: template
            value_template: >
              {% set tracker_entities = presence_trackers | default([]) %}
              {% set logic = return_trigger_logic %}
              {% if tracker_entities | length == 0 %}
                false
              {% elif logic == 'any_home' %}
                {{ expand(tracker_entities) | selectattr('state', 'eq', 'home') | list | length > 0 }}
              {% elif logic == 'all_home' %}
                {{ expand(tracker_entities) | selectattr('state', 'eq', 'home') | list | length == tracker_entities | length }}
              {% else %}
                false
              {% endif %}
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ return_from_away_mode == 'time_based' }}"
                sequence:
                  - service: input_select.select_option
                    target:
                      entity_id: !input mode_selector
                    data:
                      option: >
                        {% set nowdt = now() %}
                        {% set m = today_at(morning_time) %}
                        {% set e = today_at(evening_time) %}
                        {% set n = today_at(night_time) %}
                        {% if nowdt >= n or nowdt < m %}
                          {{ night_mode }}
                        {% elif nowdt >= e %}
                          {{ evening_mode }}
                        {% else %}
                          {{ morning_mode }}
                        {% endif %}
            default:
              - service: input_select.select_option
                target:
                  entity_id: !input mode_selector
                data:
                  option: !input return_mode
      
      
      # Startup mode setting
      - conditions:
          - condition: trigger
            id: "startup"
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input mode_selector
            data:
              option: >
                {% set nowdt = now() %}
                {% set m = today_at(morning_time) %}
                {% set e = today_at(evening_time) %}
                {% set n = today_at(night_time) %}
                {% if nowdt >= n or nowdt < m %}
                  {{ night_mode }}
                {% elif nowdt >= e %}
                  {{ evening_mode }}
                {% else %}
                  {{ morning_mode }}
                {% endif %}

mode: queued
max: 10
