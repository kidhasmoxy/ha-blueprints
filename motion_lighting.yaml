blueprint:
  name: "Motion & Mode Lighting — Per-Mode Scenes/Entities + AUX (v6.5.1, HA 2024.6+ fixes)"
  description: >
    Hubitat-style motion lighting with collapsible sections.
    • Activators: motion/occupancy OR ANY binary sensor (no device class required), contact sensors; plus keep-alive
    • Per-mode: optional Scene OR explicit Light Entities (+ brightness/color for Entities)
    • AUX-ON/AUX-OFF per mode; camera-based lux bypass; optional lux OFF gate
    • Watch window + lockout on manual OFF; capture level overrides on level/CT/color change
    • Validation-safe: lights/AUX use target.entity_id (lists), scenes use target.entity_id (HA 2024.6+)
    • v6.5.1: Fixed undefined template variables (scene_evening → scene_eve, scene_night → scene_ngt)
    • v6.5.0: Fixed service calls to use target.entity_id instead of data.entity_id (HA 2024.6+ compatibility)
    • v6.4.9: Lux sensor truly optional (no save error), "person" domain removed from activators, broader binary_sensor support
  domain: automation
  homeassistant:
    min_version: "2024.6.0"

  input:
    # =========================
    # Activation Sensors
    # =========================
    activation:
      name: "Activation sensors"
      icon: mdi:motion-sensor
      collapsed: false
      input:
        motion_or_presence_sensors:
          name: "Motion / Occupancy / ANY Binary Sensor (activate)"
          description: >
            Any of these going to 'on' activates. You can include plain binary_sensors with no device_class.
          selector:
            entity:
              multiple: true
              filter:
                - domain: binary_sensor
        contact_sensors:
          name: "Contact sensors (activate on open)"
          default: []
          selector:
            entity:
              multiple: true
              filter:
                - domain: binary_sensor
                  device_class: door
                - domain: binary_sensor
                  device_class: window
                - domain: binary_sensor
                  device_class: opening
        keepalive_sensors:
          name: "Keep-alive sensors (don’t activate)"
          description: Any binary sensor that should keep lights on (no activation).
          default: []
          selector:
            entity:
              multiple: true
              filter:
                - domain: binary_sensor

    # =========================
    # Lux & Camera Force-ON
    # =========================
    lux:
      name: "Lux conditions (with camera force-on)"
      icon: mdi:weather-sunny-alert
      collapsed: true
      input:
        lux_sensor:
          name: "Illuminance (optional)"
          description: "Leave blank to disable lux gates."
          default: ""
          selector:
            entity:
              filter:
                - domain: sensor
                  device_class: illuminance
        on_lux_max:
          name: "Only turn ON if lux below"
          default: 0
          selector:
            number:
              min: 0
              max: 5000
              unit_of_measurement: lx
              mode: box
        off_lux_min:
          name: "Turn OFF if lux ≥"
          description: "If lux sensor is blank, this OFF gate is ignored."
          default: 0
          selector:
            number:
              min: 0
              max: 5000
              unit_of_measurement: lx
              mode: box

        # Camera / “night mode” force-ON gates
        force_on_value_sensors:
          name: "Force-ON: value sensors"
          description: "Sensors whose *value* forces ON (e.g., camera color mode)."
          default: []
          selector:
            entity:
              multiple: true
              filter:
                - domain: sensor
        force_on_match_values:
          name: "Match values (comma-separated)"
          description: "Case-insensitive values that force ON (e.g., black and white,bw,night)"
          default: "black and white,bw,night"
          selector: { text: {} }
        force_on_binary_sensors:
          name: "Force-ON: binary sensors"
          description: "Binary sensors that force ON when at the chosen state (e.g., camera night mode)."
          default: []
          selector:
            entity:
              multiple: true
              filter:
                - domain: binary_sensor
        force_on_binary_state:
          name: "Binary force-ON state"
          description: "Which state of the binary sensors should force ON"
          default: "on"
          selector:
            select:
              mode: dropdown
              options: ["on", "off"]

    # =========================
    # Modes & Labels
    # =========================
    modes:
      name: "Modes & per-mode setup"
      icon: mdi:theme-light-dark
      collapsed: false
      input:
        mode_helper:
          name: "Mode helper (input_select)"
          selector:
            entity:
              filter:
                - domain: input_select
        mode_day_value:
          name: "Mode label — Day"
          default: Day
          selector: { text: {} }
        mode_evening_value:
          name: "Mode label — Evening"
          default: Evening
          selector: { text: {} }
        mode_night_value:
          name: "Mode label — Night"
          default: Night
          selector: { text: {} }

    # ---- Day section ----
    mode_day_section:
      name: "Mode: Day"
      icon: mdi:white-balance-sunny
      collapsed: false
      input:
        scene_day:
          name: "Scene (optional)"
          default: ""
          selector:
            entity:
              filter:
                - domain: scene
        entities_day:
          name: "Light entities (used if no Scene)"
          description: "Pick light entities (not areas/devices)."
          default: []
          selector:
            entity:
              multiple: true
              filter:
                - domain: light
        day_brightness:
          name: "Brightness % (for Entities)"
          default: 100
          selector: { number: { min: 1, max: 100, step: 1 } }
        day_kelvin:
          name: "Color temperature (Kelvin, 0=skip)"
          default: 0
          selector: { number: { min: 0, max: 6500, step: 50 } }
        day_rgb:
          name: "RGB color (optional)"
          description: If set, overrides Kelvin.
          default: []
          selector: { color_rgb: }
        aux_on_day_entities:
          name: "AUX-ON (also turn on — entities)"
          default: []
          selector:
            entity:
              multiple: true
        aux_off_day_entities:
          name: "AUX-OFF (also turn off — entities)"
          default: []
          selector:
            entity:
              multiple: true
        day_off_delay:
          name: "Off-delay seconds"
          default: 900
          selector: { number: { min: 0, max: 86400, step: 1 } }

    # ---- Evening section ----
    mode_evening_section:
      name: "Mode: Evening"
      icon: mdi:weather-sunset
      collapsed: true
      input:
        scene_evening:
          name: "Scene (optional)"
          default: ""
          selector:
            entity:
              filter:
                - domain: scene
        entities_evening:
          name: "Light entities (used if no Scene)"
          description: "Pick light entities (not areas/devices)."
          default: []
          selector:
            entity:
              multiple: true
              filter:
                - domain: light
        evening_brightness:
          name: "Brightness % (for Entities)"
          default: 100
          selector: { number: { min: 1, max: 100, step: 1 } }
        evening_kelvin:
          name: "Color temperature (Kelvin, 0=skip)"
          default: 3000
          selector: { number: { min: 0, max: 6500, step: 50 } }
        evening_rgb:
          name: "RGB color (optional)"
          default: []
          selector: { color_rgb: }
        aux_on_evening_entities:
          name: "AUX-ON (also turn on — entities)"
          default: []
          selector:
            entity:
              multiple: true
        aux_off_evening_entities:
          name: "AUX-OFF (also turn off — entities)"
          default: []
          selector:
            entity:
              multiple: true
        evening_off_delay:
          name: "Off-delay seconds"
          default: 900
          selector: { number: { min: 0, max: 86400, step: 1 } }

    # ---- Night section ----
    mode_night_section:
      name: "Mode: Night"
      icon: mdi:weather-night
      collapsed: true
      input:
        scene_night:
          name: "Scene (optional)"
          default: ""
          selector:
            entity:
              filter:
                - domain: scene
        entities_night:
          name: "Light entities (used if no Scene)"
          description: "Pick light entities (not areas/devices)."
          default: []
          selector:
            entity:
              multiple: true
              filter:
                - domain: light
        night_brightness:
          name: "Brightness % (for Entities)"
          default: 10
          selector: { number: { min: 1, max: 100, step: 1 } }
        night_kelvin:
          name: "Color temperature (Kelvin, 0=skip)"
          default: 2000
          selector: { number: { min: 0, max: 6500, step: 50 } }
        night_rgb:
          name: "RGB color (optional)"
          default: []
          selector: { color_rgb: }
        aux_on_night_entities:
          name: "AUX-ON (also turn on — entities)"
          default: []
          selector:
            entity:
              multiple: true
        aux_off_night_entities:
          name: "AUX-OFF (also turn off — entities)"
          default: []
          selector:
            entity:
              multiple: true
        night_off_delay:
          name: "Off-delay seconds"
          default: 60
          selector: { number: { min: 0, max: 86400, step: 1 } }

    # =========================
    # Watch Window, Lockout & Override (minutes)
    # =========================
    lockout_override:
      name: "Watch window, lockout & override"
      icon: mdi:account-cancel
      collapsed: false
      input:
        watch_window_minutes:
          name: "Watch window after activation (minutes)"
          description: "During this period: Manual OFF ⇒ Lockout; Level change ⇒ Capture override"
          default: 5
          selector:
            number:
              min: 1
              max: 60
              step: 1

        # Manual OFF ⇒ Lockout
        lockout_watch_lights:
          name: "Lights to watch for MANUAL-OFF"
          description: "If any is turned OFF during the watch window, start lockout."
          default: []
          selector:
            entity:
              multiple: true
              filter:
                - domain: light
        manual_off_lockout_mode:
          name: "Manual-OFF source to react to"
          description: "Digital only (UI/app/voice), Physical only (no context), or Any"
          default: "Any"
          selector:
            select:
              mode: dropdown
              options: ["Digital only", "Physical only", "Any"]
        manual_off_lockout_timeout:
          name: "Lockout timeout (minutes)"
          description: "Range 1–120 minutes (1 min to 2 hours)"
          default: 15
          selector:
            number:
              min: 1
              max: 120
              step: 1
        lockout_end_mode:
          name: "How does lockout end?"
          default: "Timeout or Mode change"
          selector:
            select:
              mode: dropdown
              options: ["Timeout", "Until Mode change", "Timeout or Mode change"]
        lockout_timer:
          name: "Timer for lockout (optional, recommended)"
          description: "If set, lockout uses this timer (restart-safe)."
          default: ""
          selector:
            entity:
              filter:
                - domain: timer

        # Level change ⇒ Override
        override_capture_lights:
          name: "Lights to watch for LEVEL changes (capture override)"
          description: "If a level/CT/color change happens during the watch window, snapshot it and reuse on motion."
          default: []
          selector:
            entity:
              multiple: true
              filter:
                - domain: light
        override_change_source:
          name: "Whose changes count for override capture?"
          default: "Any"
          selector:
            select:
              mode: dropdown
              options: ["Digital only", "Physical only", "Any"]
        override_timeout_minutes:
          name: "Override timeout (minutes)"
          description: "How long to reuse the captured levels (1–120)"
          default: 60
          selector:
            number:
              min: 1
              max: 120
              step: 1
        override_end_mode:
          name: "When should override end?"
          default: "Timeout or Mode change"
          selector:
            select:
              mode: dropdown
              options: ["Timeout", "Until Mode change", "Timeout or Mode change"]
        override_timer:
          name: "Timer for override (optional, recommended)"
          description: "If set, we keep override active with this timer (restart-safe)."
          default: ""
          selector:
            entity:
              filter:
                - domain: timer

    # =========================
    # Misc
    # =========================
    misc:
      name: "Misc options"
      icon: mdi:tune
      collapsed: true
      input:
        force_on_even_if_on:
          name: "Force apply even if already on"
          default: false
          selector: { boolean: {} }
        disable_off_via_boolean:
          name: "Disable OFF via boolean (e.g., cleaning/party)"
          default: ""
          selector:
            entity:
              filter:
                - domain: input_boolean
        debug_logging:
          name: "Enable debug logbook entries"
          default: false
          selector: { boolean: {} }

# ====== Runtime
mode: restart

variables:
  # Sensors & lux
  motion_list: !input motion_or_presence_sensors
  contacts_list: !input contact_sensors
  keepalive_list: !input keepalive_sensors
  lux_entity: !input lux_sensor
  on_lux_max: !input on_lux_max
  off_lux_min: !input off_lux_min

  # Camera / override-for-lux inputs
  force_on_value_sensors: !input force_on_value_sensors
  force_on_match_values: !input force_on_match_values
  force_on_binary_sensors: !input force_on_binary_sensors
  force_on_binary_state: !input force_on_binary_state

  # Compute: camera indicates it's dark?
  force_cam_on: >
    {% set vals = (force_on_match_values | default('') | lower).split(',') | map('trim') | select('string') | list %}
    {% set val_hit = (
      expand(force_on_value_sensors)
      | map(attribute='state')
      | map('lower')
      | select('in', vals)
      | list
      | length > 0
    ) if vals | length > 0 else false %}
    {% set bin_hit = (
      expand(force_on_binary_sensors)
      | selectattr('state','eq', force_on_binary_state)
      | list
      | length > 0
    ) %}
    {{ val_hit or bin_hit }}

  # Modes
  mode_entity: !input mode_helper
  mode_day: !input mode_day_value
  mode_eve: !input mode_evening_value
  mode_ngt: !input mode_night_value
  mode_now: "{{ states(mode_entity) if mode_entity else 'Day' }}"

  # Per-mode scenes/entities/levels
  scene_day: !input scene_day
  scene_eve: !input scene_evening
  scene_ngt: !input scene_night

  entities_day: !input entities_day
  entities_eve: !input entities_evening
  entities_ngt: !input entities_night

  day_bri: !input day_brightness
  eve_bri: !input evening_brightness
  ngt_bri: !input night_brightness
  day_kelvin: !input day_kelvin
  eve_kelvin: !input evening_kelvin
  ngt_kelvin: !input night_kelvin
  day_rgb: !input day_rgb
  eve_rgb: !input evening_rgb
  ngt_rgb: !input night_rgb

  aux_on_day_entities: !input aux_on_day_entities
  aux_on_eve_entities: !input aux_on_evening_entities
  aux_on_ngt_entities: !input aux_on_night_entities
  aux_off_day_entities: !input aux_off_day_entities
  aux_off_eve_entities: !input aux_off_evening_entities
  aux_off_ngt_entities: !input aux_off_night_entities

  # Off delays
  day_off: !input day_off_delay
  eve_off: !input evening_off_delay
  ngt_off: !input night_off_delay
  off_delay: >
    {% set m = states(mode_entity) if mode_entity else 'Day' %}
    {% if m == mode_day %}{{ day_off }}
    {% elif m == mode_eve %}{{ eve_off }}
    {% elif m == mode_ngt %}{{ ngt_off }}
    {% else %}{{ day_off }}{% endif %}

  # Watch window & lockout (MINUTES)
  watch_window: !input watch_window_minutes
  lockout_watch: !input lockout_watch_lights
  lockout_mode: !input manual_off_lockout_mode
  lockout_timeout_min: !input manual_off_lockout_timeout
  lockout_end_mode: !input lockout_end_mode
  lockout_timer: !input lockout_timer

  # Override capture (MINUTES)
  override_capture_lights: !input override_capture_lights
  override_change_source: !input override_change_source
  override_timeout_min: !input override_timeout_minutes
  override_end_mode: !input override_end_mode
  override_timer: !input override_timer
  override_scene_id: "{{ (this.entity_id | replace('.','_')) ~ '_level_override' }}"

  # Misc
  force_on_even_if_on: !input force_on_even_if_on
  disable_off_bool: !input disable_off_via_boolean
  debug: !input debug_logging

trigger:
  # Activators (ANY binary_sensor -> on; Contacts -> on/open)
  - platform: state
    id: motion_on
    entity_id: !input motion_or_presence_sensors
    to: "on"
  - platform: state
    id: contact_open
    entity_id: !input contact_sensors
    to: "on"
  - platform: state
    id: contact_open_alt
    entity_id: !input contact_sensors
    to: "open"

  # Idle/closed → for timer-based OFF
  - platform: state
    id: motion_off
    entity_id: !input motion_or_presence_sensors
    to: "off"
  - platform: state
    id: contact_closed
    entity_id: !input contact_sensors
    to: "off"
  - platform: state
    id: contact_closed_alt
    entity_id: !input contact_sensors
    to: "closed"

  # Keepalive (handle on/open)
  - platform: state
    id: keepalive_on
    entity_id: !input keepalive_sensors
    to: "on"
  - platform: state
    id: keepalive_open
    entity_id: !input keepalive_sensors
    to: "open"

  # Mode change
  - platform: state
    id: mode_change
    entity_id: !input mode_helper

  # Lux-based immediate OFF (template trigger; SAFE if lux sensor is blank)
  - platform: template
    id: lux_off
    value_template: >
      {% set le = lux_entity %}
      {% if le and (off_lux_min|int > 0) %}
        {{ states(le)|float(0) >= off_lux_min|int }}
      {% else %} false {% endif %}

condition: []

action:
  - variables:
      disable_off_now: "{{ is_state(disable_off_bool,'on') if disable_off_bool else false }}"
      any_motion_on: "{{ expand(motion_list)|selectattr('state','eq','on')|list|count > 0 }}"
      any_contact_open: "{{ expand(contacts_list)|selectattr('state','in',['on','open'])|list|count > 0 }}"
      any_keepalive_on: "{{ expand(keepalive_list)|selectattr('state','in',['on','open'])|list|count > 0 }}"
      lux_ok_to_on: >
        {% if lux_entity and on_lux_max|int > 0 %}
          {{ states(lux_entity)|float(9999) < on_lux_max|int }}
        {% else %}true{% endif %}

  - choose:

      # MODE CHANGE: cancel timers depending on policy
      - conditions:
          - condition: trigger
            id: mode_change
        sequence:
          - choose:
              - conditions: "{{ debug }}"
                sequence:
                  - service: logbook.log
                    data:
                      name: "MotionMode v6.5.1"
                      message: "Mode changed to '{{ states(mode_entity) }}'. Evaluating cancel policies."
                      entity_id: "{{ this.entity_id }}"
          - choose:
              - conditions: >
                  {{ (lockout_timer|default('')) != '' and lockout_end_mode in ['Until Mode change','Timeout or Mode change'] }}
                sequence:
                  - service: timer.cancel
                    target:
                      entity_id: !input lockout_timer
              - conditions: >
                  {{ (override_timer|default('')) != '' and override_end_mode in ['Until Mode change','Timeout or Mode change'] }}
                sequence:
                  - service: timer.cancel
                    target:
                      entity_id: !input override_timer

      # LUX-OFF (immediate): turn everything off for the active mode
      - conditions:
          - condition: trigger
            id: lux_off
          - condition: template
            value_template: "{{ not any_motion_on and not any_contact_open and not any_keepalive_on }}"
          - condition: template
            value_template: "{{ not disable_off_now }}"
        sequence:
          - choose:
              - conditions: "{{ debug }}"
                sequence:
                  - service: logbook.log
                    data:
                      name: "MotionMode v6.5.1"
                      message: "Lux-OFF branch running."
                      entity_id: "{{ this.entity_id }}"
          - choose:
              - conditions: "{{ states(mode_entity) == mode_day }}"
                sequence:
                  - choose:
                      - conditions: "{{ aux_off_day_entities | length > 0 }}"
                        sequence:
                          - service: homeassistant.turn_off
                            target:
                              entity_id: !input aux_off_day_entities
                  - choose:
                      - conditions: "{{ aux_on_day_entities | length > 0 }}"
                        sequence:
                          - service: homeassistant.turn_off
                            target:
                              entity_id: !input aux_on_day_entities
                  - choose:
                      - conditions: "{{ entities_day | length > 0 }}"
                        sequence:
                          - service: homeassistant.turn_off
                            target:
                              entity_id: !input entities_day
              - conditions: "{{ states(mode_entity) == mode_eve }}"
                sequence:
                  - choose:
                      - conditions: "{{ aux_off_evening_entities | length > 0 }}"
                        sequence:
                          - service: homeassistant.turn_off
                            target:
                              entity_id: !input aux_off_evening_entities
                  - choose:
                      - conditions: "{{ aux_on_evening_entities | length > 0 }}"
                        sequence:
                          - service: homeassistant.turn_off
                            target:
                              entity_id: !input aux_on_evening_entities
                  - choose:
                      - conditions: "{{ entities_eve | length > 0 }}"
                        sequence:
                          - service: homeassistant.turn_off
                            target:
                              entity_id: !input entities_evening
              - conditions: "{{ states(mode_entity) == mode_ngt }}"
                sequence:
                  - choose:
                      - conditions: "{{ aux_off_night_entities | length > 0 }}"
                        sequence:
                          - service: homeassistant.turn_off
                            target:
                              entity_id: !input aux_off_night_entities
                  - choose:
                      - conditions: "{{ aux_on_night_entities | length > 0 }}"
                        sequence:
                          - service: homeassistant.turn_off
                            target:
                              entity_id: !input aux_on_night_entities
                  - choose:
                      - conditions: "{{ entities_ngt | length > 0 }}"
                        sequence:
                          - service: homeassistant.turn_off
                            target:
                              entity_id: !input entities_night

      # ACTIVATE on motion/contact, respecting lux OR camera force and lockout
      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: motion_on
              - condition: trigger
                id: contact_open
              - condition: trigger
                id: contact_open_alt
          - condition: template
            value_template: "{{ lux_ok_to_on or force_cam_on }}"
          # Block while lockout timer is active (if provided)
          - condition: template
            value_template: >
              {% set lt = (lockout_timer | default('')) %}
              {{ not lt or is_state(lt, 'idle') }}
        sequence:

          - choose:
              - conditions: "{{ debug }}"
                sequence:
                  - service: logbook.log
                    data:
                      name: "MotionMode v6.5.1"
                      message: >
                        ACTIVATE: Mode='{{ states(mode_entity) }}';
                        lux_ok={{ lux_ok_to_on }}, force_cam_on={{ force_cam_on }};
                        Day scene='{{ scene_day }}' entities={{ entities_day|length }};
                        Eve scene='{{ scene_eve }}' entities={{ entities_eve|length }};
                        Ngt scene='{{ scene_ngt }}' entities={{ entities_ngt|length }}.
                      entity_id: "{{ this.entity_id }}"

          # If override timer is active, apply captured look and stop
          - choose:
              - conditions: >
                  {{ (override_timer | default('')) != '' and is_state(override_timer, 'active') }}
                sequence:
                  - service: scene.turn_on
                    target:
                      entity_id: "scene.{{ override_scene_id }}"
                  - choose:
                      - conditions: "{{ debug }}"
                        sequence:
                          - service: logbook.log
                            data:
                              name: "MotionMode v6.5.1"
                              message: "Applied OVERRIDE scene scene.{{ override_scene_id }}"
                              entity_id: "{{ this.entity_id }}"
                  - stop: "Applied override scene (timer active)"
            default: []

{{ ... }}
          # Guard: no targets for current mode
          - choose:
              - conditions: >
                  {% set m = states(mode_entity) %}
                  {{ (m == mode_day and (scene_day == '' and (entities_day|length)==0)) or
                     (m == mode_eve and (scene_eve == '' and (entities_eve|length)==0)) or
                     (m == mode_ngt and (scene_ngt == '' and (entities_ngt|length)==0)) or
                     (m not in [mode_day, mode_eve, mode_ngt]) }}
                sequence:
                  - choose:
                      - conditions: "{{ debug }}"
                        sequence:
                          - service: logbook.log
                            data:
                              name: "MotionMode v6.5.1"
                              message: "Guard: No scene/entities for current mode; stopping."
                              entity_id: "{{ this.entity_id }}"
                  - stop: "No targets for current mode"

          # Apply per-mode scene/entities and AUX-ON
          - choose:

              - conditions: "{{ states(mode_entity) == mode_day }}"
                sequence:
                  - choose:
                      - conditions: "{{ scene_day != '' }}"
                        sequence:
                          - service: scene.turn_on
                            target:
                              entity_id: "{{ scene_day }}"
                  - choose:
                      - conditions: "{{ entities_day | length > 0 }}"
                        sequence:
                          - choose:
                              - conditions: "{{ (day_rgb | length) > 0 }}"
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: !input entities_day
                                    data:
                                      brightness_pct: "{{ day_bri|int }}"
                                      rgb_color: "{{ day_rgb }}"
                              - conditions: "{{ (day_rgb | length) == 0 and day_kelvin|int > 0 }}"
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: !input entities_day
                                    data:
                                      brightness_pct: "{{ day_bri|int }}"
                                      color_temp_kelvin: "{{ day_kelvin|int }}"
                              - conditions: []
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: !input entities_day
                                    data:
                                      brightness_pct: "{{ day_bri|int }}"
                  - choose:
                      - conditions: "{{ aux_on_day_entities | length > 0 }}"
                        sequence:
                          - service: homeassistant.turn_on
                            target:
                              entity_id: !input aux_on_day_entities
                  - if:
                      - condition: template
                        value_template: "{{ force_on_even_if_on }}"
                    then:
                      - service: homeassistant.turn_on
                        target:
                          entity_id: !input entities_day

              - conditions: "{{ states(mode_entity) == mode_eve }}"
                sequence:
                  - choose:
                      - conditions: "{{ scene_eve != '' }}"
                        sequence:
                          - service: scene.turn_on
                            target:
                              entity_id: "{{ scene_eve }}"
                  - choose:
                      - conditions: "{{ entities_eve | length > 0 }}"
                        sequence:
                          - choose:
                              - conditions: "{{ (evening_rgb | length) > 0 }}"
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: !input entities_evening
                                    data:
                                      brightness_pct: "{{ eve_bri|int }}"
                                      rgb_color: "{{ evening_rgb }}"
                              - conditions: "{{ (evening_rgb | length) == 0 and eve_kelvin|int > 0 }}"
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: !input entities_evening
                                    data:
                                      brightness_pct: "{{ eve_bri|int }}"
                                      color_temp_kelvin: "{{ eve_kelvin|int }}"
                              - conditions: []
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: !input entities_evening
                                    data:
                                      brightness_pct: "{{ eve_bri|int }}"
                  - choose:
                      - conditions: "{{ aux_on_evening_entities | length > 0 }}"
                        sequence:
                          - service: homeassistant.turn_on
                            target:
                              entity_id: !input aux_on_evening_entities
                  - if:
                      - condition: template
                        value_template: "{{ force_on_even_if_on }}"
                    then:
                      - service: homeassistant.turn_on
                        target:
                          entity_id: !input entities_evening

              - conditions: "{{ states(mode_entity) == mode_ngt }}"
                sequence:
                  - choose:
                      - conditions: "{{ scene_ngt != '' }}"
                        sequence:
                          - service: scene.turn_on
                            target:
                              entity_id: "{{ scene_ngt }}"
                  - choose:
                      - conditions: "{{ entities_ngt | length > 0 }}"
                        sequence:
                          - choose:
                              - conditions: "{{ (night_rgb | length) > 0 }}"
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: !input entities_night
                                    data:
                                      brightness_pct: "{{ ngt_bri|int }}"
                                      rgb_color: "{{ night_rgb }}"
                              - conditions: "{{ (night_rgb | length) == 0 and ngt_kelvin|int > 0 }}"
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: !input entities_night
                                    data:
                                      brightness_pct: "{{ ngt_bri|int }}"
                                      color_temp_kelvin: "{{ ngt_kelvin|int }}"
                              - conditions: []
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: !input entities_night
                                    data:
                                      brightness_pct: "{{ ngt_bri|int }}"
                  - choose:
                      - conditions: "{{ aux_on_night_entities | length > 0 }}"
                        sequence:
                          - service: homeassistant.turn_on
                            target:
                              entity_id: !input aux_on_night_entities
                  - if:
                      - condition: template
                        value_template: "{{ force_on_even_if_on }}"
                    then:
                      - service: homeassistant.turn_on
                        target:
                          entity_id: !input entities_night

          # === Start a watch window after activation (MINUTES) ===
          - wait_for_trigger:
              - platform: state
                id: "manual_off"
                entity_id: !input lockout_watch_lights
                to: "off"
              - platform: state
                id: "level_change"
                entity_id: !input override_capture_lights
                from: "on"
                to: "on"
            timeout:
              minutes: "{{ watch_window|int }}"
            continue_on_timeout: false

          - choose:
              # --- Manual OFF detected → start lockout ---
              - conditions:
                  - condition: template
                    value_template: "{{ wait.trigger is not none and wait.trigger.id == 'manual_off' }}"
                  # Source filter for lockout
                  - condition: template
                    value_template: >
                      {% set uid = wait.trigger.to_state.context.user_id %}
                      {% set pid = wait.trigger.to_state.context.parent_id %}
                      {% if lockout_mode == 'Digital only' %}
                        {{ uid is not none }}
                      {% elif lockout_mode == 'Physical only' %}
                        {{ uid is none and pid is none }}
                      {% else %} true {% endif %}
                sequence:
                  - choose:
                      - conditions: "{{ (lockout_timer | default('')) != '' }}"
                        sequence:
                          - service: timer.start
                            target:
                              entity_id: !input lockout_timer
                            data:
                              duration: "{{ (lockout_timeout_min|int) * 60 }}"
                      - conditions: []
                        sequence:
                          - service: automation.turn_off
                            target:
                              entity_id: "{{ this.entity_id }}"
                          - delay:
                              minutes: "{{ lockout_timeout_min|int }}"
                          - service: automation.turn_on
                            target:
                              entity_id: "{{ this.entity_id }}"

              # --- Level/CT/Color change → capture override (no lockout) ---
              - conditions:
                  - condition: template
                    value_template: "{{ wait.trigger is not none and wait.trigger.id == 'level_change' }}"
                  # Source filter for override capture
                  - condition: template
                    value_template: >
                      {% set uid = wait.trigger.to_state.context.user_id %}
                      {% set pid = wait.trigger.to_state.context.parent_id %}
                      {% if override_change_source == 'Digital only' %}
                        {{ uid is not none }}
                      {% elif override_change_source == 'Physical only' %}
                        {{ uid is none and pid is none }}
                      {% else %} true {% endif %}
                sequence:
                  - service: scene.create
                    data:
                      scene_id: "{{ override_scene_id }}"
                      snapshot_entities: !input override_capture_lights
                  - choose:
                      - conditions: "{{ (override_timer | default('')) != '' }}"
                        sequence:
                          - service: timer.start
                            target:
                              entity_id: !input override_timer
                            data:
                              duration: "{{ (override_timeout_min|int) * 60 }}"

      # ==== Timer-based OFF (idle or mode change) ====
      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: motion_off
              - condition: trigger
                id: contact_closed
              - condition: trigger
                id: contact_closed_alt
              - condition: trigger
                id: mode_change
        sequence:
          - choose:
              - conditions: "{{ debug }}"
                sequence:
                  - service: logbook.log
                    data:
                      name: "MotionMode v6.5.1"
                      message: "Timer-OFF branch waiting {{ off_delay|int }}s."
                      entity_id: "{{ this.entity_id }}"
          - wait_for_trigger:
              - platform: state
                entity_id: !input motion_or_presence_sensors
                to: "on"
              - platform: state
                entity_id: !input contact_sensors
                to: "on"
              - platform: state
                entity_id: !input keepalive_sensors
                to: "on"
              - platform: state
                entity_id: !input keepalive_sensors
                to: "open"
            timeout:
              seconds: "{{ off_delay|int }}"
            continue_on_timeout: true
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ wait.trigger is not none }}"
                sequence: []
              - conditions: []
                sequence:
                  - condition: template
                    value_template: "{{ not disable_off_now }}"
                  - choose:
                      - conditions: "{{ states(mode_entity) == mode_day }}"
                        sequence:
                          - choose:
                              - conditions: "{{ aux_off_day_entities | length > 0 }}"
                                sequence:
                                  - service: homeassistant.turn_off
                                    target:
                                      entity_id: !input aux_off_day_entities
                          - choose:
                              - conditions: "{{ aux_on_day_entities | length > 0 }}"
                                sequence:
                                  - service: homeassistant.turn_off
                                    target:
                                      entity_id: !input aux_on_day_entities
                          - choose:
                              - conditions: "{{ entities_day | length > 0 }}"
                                sequence:
                                  - service: homeassistant.turn_off
                                    target:
                                      entity_id: !input entities_day
                      - conditions: "{{ states(mode_entity) == mode_eve }}"
                        sequence:
                          - choose:
                              - conditions: "{{ aux_off_evening_entities | length > 0 }}"
                                sequence:
                                  - service: homeassistant.turn_off
                                    target:
                                      entity_id: !input aux_off_evening_entities
                          - choose:
                              - conditions: "{{ aux_on_evening_entities | length > 0 }}"
                                sequence:
                                  - service: homeassistant.turn_off
                                    target:
                                      entity_id: !input aux_on_evening_entities
                          - choose:
                              - conditions: "{{ entities_eve | length > 0 }}"
                                sequence:
                                  - service: homeassistant.turn_off
                                    target:
                                      entity_id: !input entities_evening
                      - conditions: "{{ states(mode_entity) == mode_ngt }}"
                        sequence:
                          - choose:
                              - conditions: "{{ aux_off_night_entities | length > 0 }}"
                                sequence:
                                  - service: homeassistant.turn_off
                                    target:
                                      entity_id: !input aux_off_night_entities
                          - choose:
                              - conditions: "{{ aux_on_night_entities | length > 0 }}"
                                sequence:
                                  - service: homeassistant.turn_off
                                    target:
                                      entity_id: !input aux_on_night_entities
                          - choose:
                              - conditions: "{{ entities_ngt | length > 0 }}"
                                sequence:
                                  - service: homeassistant.turn_off
                                    target:
                                      entity_id: !input entities_night
