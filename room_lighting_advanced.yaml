blueprint:
  name: Advanced Room Lighting (Hubitat Style) v1.0
  description: |
    Comprehensive room lighting automation that replicates Hubitat Room Lighting functionality (v1.0).
    Features motion detection, contact sensors, buttons, illuminance control, per-mode settings,
    advanced conditions, fade times, delays, and sophisticated turn-off logic.
  domain: automation
  input:
    room_setup_section:
      name: "ðŸ  Room Setup"
      description: "Configure room name and area selection"
      collapsed: true
      input:
        area_selector:
          name: Area (Optional)
          description: Select an area to automatically populate room name and suggest devices
          default: {}
          selector:
            area: {}
        
        room_name:
          name: Room Name (Override)
          description: Override the area name or provide a custom room name
          default: ""
          selector:
            text: {}
    devices_section:
      name: "ðŸ’¡ Devices to Automate"
      description: "Select the lights and devices to control"
      collapsed: true
      input:
        # Light Group 1
        light_group_1_name:
          name: Light Group 1 Name
          description: Name for the first group of lights (e.g., "Main Lights")
          default: "Main Lights"
          selector:
            text: {}
        
        light_group_1_entities:
          name: Light Group 1 - Entities
          description: Select lights for Group 1
          default: {}
          selector:
            target:
              entity:
                - domain: light
                - domain: switch
                - domain: fan
        
        # Light Group 2
        light_group_2_name:
          name: Light Group 2 Name (Optional)
          description: Name for the second group of lights (e.g., "Accent Lights")
          default: ""
          selector:
            text: {}
        
        light_group_2_entities:
          name: Light Group 2 - Entities
          description: Select lights for Group 2
          default: {}
          selector:
            target:
              entity:
                - domain: light
                - domain: switch
                - domain: fan
        
        # Light Group 3
        light_group_3_name:
          name: Light Group 3 Name (Optional)
          description: Name for the third group of lights (e.g., "Night Lights")
          default: ""
          selector:
            text: {}
        
        light_group_3_entities:
          name: Light Group 3 - Entities
          description: Select lights for Group 3
          default: {}
          selector:
            target:
              entity:
                - domain: light
                - domain: switch
                - domain: fan
    activation_triggers_section:
      name: "ðŸšª Means to Activate"
      description: "Configure sensors and devices that trigger light activation"
      collapsed: true
      input:
        motion_sensors:
          name: Motion Sensors
          description: Motion sensors that activate lights
          default: {}
          selector:
            target:
              entity:
                domain: binary_sensor
                device_class: motion
        
        contact_sensors:
          name: Contact Sensors (Doors/Windows)
          description: Contact sensors that activate lights when opened
          default: {}
          selector:
            target:
              entity:
                domain: binary_sensor
                device_class: 
                  - door
                  - window
                  - garage_door
        
        button_devices:
          name: Button Devices
          description: Buttons, switches, or remotes that activate lights
          default: {}
          selector:
            target:
              entity:
                - domain: sensor
                - domain: binary_sensor
                - domain: device_tracker
        
        illuminance_sensor:
          name: Illuminance Sensor (Optional)
          description: Light sensor to prevent activation during bright conditions
          default: {}
          selector:
            entity:
              domain: sensor
              device_class: illuminance
    activation_options_section:
      name: "âš™ï¸ Activation Options"
      description: "Configure when and how lights are activated"
      collapsed: true
      input:
        enable_motion_activation:
          name: Enable Motion Activation
          description: Activate lights when motion is detected
          default: true
          selector:
            boolean: {}
        
        enable_contact_activation:
          name: Enable Contact Activation
          description: Activate lights when doors/windows open
          default: false
          selector:
            boolean: {}
        
        enable_button_activation:
          name: Enable Button Activation
          description: Activate lights when buttons are pressed
          default: false
          selector:
            boolean: {}
        
        enable_illuminance_control:
          name: Enable Illuminance Control
          description: Only activate if illuminance is below threshold
          default: false
          selector:
            boolean: {}
        
        illuminance_threshold:
          name: Illuminance Threshold (lux)
          description: Don't activate if illuminance is above this value
          default: 50
          selector:
            number:
              min: 0
              max: 1000
              step: 1
              mode: box
        # ==========================================
    # LIGHTING PERIODS (PER-GROUP PER-MODE SETTINGS)
    # ==========================================
    
    # Light Group 1 Settings
    group_1_away_brightness:
      name: "Group 1: Away Mode Brightness (%)"
      description: Brightness level for Group 1 when in Away mode
      default: 30
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: box
    
    group_1_day_brightness:
      name: "Group 1: Day Mode Brightness (%)"
      description: Brightness level for Group 1 when in Day mode
      default: 75
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: box
    
    group_1_evening_brightness:
      name: "Group 1: Evening Mode Brightness (%)"
      description: Brightness level for Group 1 when in Evening mode
      default: 85
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: box
    
    group_1_night_brightness:
      name: "Group 1: Night Mode Brightness (%)"
      description: Brightness level for Group 1 when in Night mode
      default: 20
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: box
    
    # Light Group 2 Settings
    group_2_away_brightness:
      name: "Group 2: Away Mode Brightness (%)"
      description: Brightness level for Group 2 when in Away mode
      default: 20
      selector:
        number:
          min: 0
          max: 100
          step: 1
          mode: box
    
    group_2_day_brightness:
      name: "Group 2: Day Mode Brightness (%)"
      description: Brightness level for Group 2 when in Day mode (0 = off)
      default: 50
      selector:
        number:
          min: 0
          max: 100
          step: 1
          mode: box
    
    group_2_evening_brightness:
      name: "Group 2: Evening Mode Brightness (%)"
      description: Brightness level for Group 2 when in Evening mode (0 = off)
      default: 70
      selector:
        number:
          min: 0
          max: 100
          step: 1
          mode: box
    
    group_2_night_brightness:
      name: "Group 2: Night Mode Brightness (%)"
      description: Brightness level for Group 2 when in Night mode (0 = off)
      default: 10
      selector:
        number:
          min: 0
          max: 100
          step: 1
          mode: box
    
    # Light Group 3 Settings
    group_3_away_brightness:
      name: "Group 3: Away Mode Brightness (%)"
      description: Brightness level for Group 3 when in Away mode (0 = off)
      default: 0
      selector:
        number:
          min: 0
          max: 100
          step: 1
          mode: box
    
    group_3_day_brightness:
      name: "Group 3: Day Mode Brightness (%)"
      description: Brightness level for Group 3 when in Day mode (0 = off)
      default: 0
      selector:
        number:
          min: 0
          max: 100
          step: 1
          mode: box
    
    group_3_evening_brightness:
      name: "Group 3: Evening Mode Brightness (%)"
      description: Brightness level for Group 3 when in Evening mode (0 = off)
      default: 30
      selector:
        number:
          min: 0
          max: 100
          step: 1
          mode: box
    
    group_3_night_brightness:
      name: "Group 3: Night Mode Brightness (%)"
      description: Brightness level for Group 3 when in Night mode (0 = off)
      default: 5
      selector:
        number:
          min: 0
          max: 100
          step: 1
          mode: box
    
    # Color Temperature Settings (Per-Group)
    enable_color_temp:
      name: Enable Color Temperature Control
      description: Adjust color temperature based on mode for all groups
      default: false
      selector:
        boolean: {}
    
    # Group 1 Color Temperature
    group_1_away_color_temp:
      name: "Group 1: Away Mode Color Temperature (K)"
      default: 3000
      selector:
        number:
          min: 2000
          max: 6500
          step: 100
          mode: box
    
    group_1_day_color_temp:
      name: "Group 1: Day Mode Color Temperature (K)"
      default: 4000
      selector:
        number:
          min: 2000
          max: 6500
          step: 100
          mode: box
    
    group_1_evening_color_temp:
      name: "Group 1: Evening Mode Color Temperature (K)"
      default: 3000
      selector:
        number:
          min: 2000
          max: 6500
          step: 100
          mode: box
    
    group_1_night_color_temp:
      name: "Group 1: Night Mode Color Temperature (K)"
      default: 2200
      selector:
        number:
          min: 2000
          max: 6500
          step: 100
          mode: box
    
    # Group 2 Color Temperature
    group_2_away_color_temp:
      name: "Group 2: Away Mode Color Temperature (K)"
      default: 2700
      selector:
        number:
          min: 2000
          max: 6500
          step: 100
          mode: box
    
    group_2_day_color_temp:
      name: "Group 2: Day Mode Color Temperature (K)"
      default: 3000
      selector:
        number:
          min: 2000
          max: 6500
          step: 100
          mode: box
    
    group_2_evening_color_temp:
      name: "Group 2: Evening Mode Color Temperature (K)"
      default: 2700
      selector:
        number:
          min: 2000
          max: 6500
          step: 100
          mode: box
    
    group_2_night_color_temp:
      name: "Group 2: Night Mode Color Temperature (K)"
      default: 2200
      selector:
        number:
          min: 2000
          max: 6500
          step: 100
          mode: box
    
    # Group 3 Color Temperature
    group_3_away_color_temp:
      name: "Group 3: Away Mode Color Temperature (K)"
      default: 2200
      selector:
        number:
          min: 2000
          max: 6500
          step: 100
          mode: box
    
    group_3_day_color_temp:
      name: "Group 3: Day Mode Color Temperature (K)"
      default: 2700
      selector:
        number:
          min: 2000
          max: 6500
          step: 100
          mode: box
    
    group_3_evening_color_temp:
      name: "Group 3: Evening Mode Color Temperature (K)"
      default: 2200
      selector:
        number:
          min: 2000
          max: 6500
          step: 100
          mode: box
    
    group_3_night_color_temp:
      name: "Group 3: Night Mode Color Temperature (K)"
      default: 2000
      selector:
        number:
          min: 2000
          max: 6500
          step: 100
          mode: box
    
    # ==========================================
    # MEANS TO TURN OFF
    # ==========================================
    motion_timeout_away:
      name: Motion Timeout - Away Mode (minutes)
      description: Minutes of no motion before turning off in Away mode
      default: 2
      selector:
        number:
          min: 0.5
          max: 1440
          step: 0.5
          mode: box
    
    motion_timeout_day:
      name: Motion Timeout - Day Mode (minutes)
      description: Minutes of no motion before turning off in Day mode
      default: 10
      selector:
        number:
          min: 0.5
          max: 1440
          step: 0.5
          mode: box
    
    motion_timeout_evening:
      name: Motion Timeout - Evening Mode (minutes)
      description: Minutes of no motion before turning off in Evening mode
      default: 15
      selector:
        number:
          min: 0.5
          max: 1440
          step: 0.5
          mode: box
    
    motion_timeout_night:
      name: Motion Timeout - Night Mode (minutes)
      description: Minutes of no motion before turning off in Night mode
      default: 5
      selector:
        number:
          min: 0.5
          max: 1440
          step: 0.5
          mode: box
    
    # Advanced Turn Off Options
    require_all_motion_clear:
      name: Require All Motion Sensors Clear
      description: All motion sensors must be clear before turning off
      default: true
      selector:
        boolean: {}
    
    require_contact_closed:
      name: Require Contact Sensors Closed
      description: Contact sensors must be closed before turning off
      default: false
      selector:
        boolean: {}
    
    prevent_motion_override:
      name: Prevent Motion Override
      description: Prevent motion from turning off lights after manual changes
      default: true
      selector:
        boolean: {}
    
    # Alternative Turn Off Devices
    alternative_turn_off_devices:
      name: Alternative Turn Off Devices
      description: Additional devices to turn off during turn-off events (TVs, fans, etc.)
      default: {}
      selector:
        target:
          entity:
            - domain: light
            - domain: switch
            - domain: fan
            - domain: media_player
    
    # ==========================================
    # ACTIVATE LIGHTS OPTIONS (CONDITIONS)
    # ==========================================
    disable_when_tv_on:
      name: Disable When TV is On
      description: Don't activate if TV or media player is on
      default: false
      selector:
        boolean: {}
    
    tv_media_player:
      name: TV/Media Player Entity
      description: Media player to check if TV is on
      default: {}
      selector:
        entity:
          domain: media_player
    
    disable_when_sleeping:
      name: Disable When Someone is Sleeping
      description: Don't activate if sleep mode is active
      default: false
      selector:
        boolean: {}
    
    sleep_sensor:
      name: Sleep Sensor/Switch
      description: Entity that indicates if someone is sleeping
      default: {}
      selector:
        entity:
          domain: 
            - binary_sensor
            - input_boolean
            - switch
    
    # ==========================================
    # TIMING AND TRANSITIONS
    # ==========================================
    activation_delay:
      name: Activation Delay (seconds)
      description: Delay before activating lights
      default: 0
      selector:
        number:
          min: 0
          max: 300
          step: 0.1
          mode: box
    
    fade_time:
      name: Fade Time (seconds)
      description: Transition time for light changes
      default: 1
      selector:
        number:
          min: 0
          max: 60
          step: 0.1
          mode: box
    
    # ==========================================
    # ADVANCED OPTIONS
    # ==========================================
    activate_even_if_partially_on:
      name: Activate Even if Partially On
      description: Activate even if some lights are already on
      default: false
      selector:
        boolean: {}
    
    turn_off_even_if_partially_off:
      name: Turn Off Even if Partially Off
      description: Turn off even if some lights are already off
      default: true
      selector:
        boolean: {}
    
    enable_occupancy_tracking:
      name: Enable Occupancy Tracking
      description: Track room occupancy state internally
      default: true
      selector:
        boolean: {}
    
    # Weekend/Weekday Differences
    enable_weekend_settings:
      name: Enable Weekend Settings
      description: Use different timeouts on weekends
      default: false
      selector:
        boolean: {}
    
    weekend_timeout_multiplier:
      name: Weekend Timeout Multiplier
      description: Multiply timeouts by this factor on weekends
      default: 1.5
      selector:
        number:
          min: 0.1
          max: 5.0
          step: 0.1
          mode: box
    
    # Debug and Testing
    enable_debug_logging:
      name: Enable Debug Logging
      description: Log detailed debug information
      default: false
      selector:
        boolean: {}

variables:
  # Determine the effective room name (area name or override)
  effective_room_name: >
    {% if room_setup_section.room_name and room_setup_section.room_name | trim != "" %}
      {{ room_setup_section.room_name }}
    {% elif room_setup_section.area_selector %}
      {{ area_name(room_setup_section.area_selector) }}
    {% else %}
      "Room"
    {% endif %}
  
  # Light group entity lists
  effective_group_1_lights: >
    {{ devices_section.light_group_1_entities.entity_id | default([]) }}
  
  effective_group_2_lights: >
    {{ devices_section.light_group_2_entities.entity_id | default([]) }}
  
  effective_group_3_lights: >
    {{ devices_section.light_group_3_entities.entity_id | default([]) }}
  
  # Combined list of all lights for triggers and conditions
  effective_lights: >
    {{ (effective_group_1_lights + effective_group_2_lights + effective_group_3_lights) | unique | list }}
  
  # Device entity lists
  effective_motion_sensors: >
    {{ activation_triggers_section.motion_sensors.entity_id | default([]) }}
  
  effective_contact_sensors: >
    {{ activation_triggers_section.contact_sensors.entity_id | default([]) }}
  
  effective_button_devices: >
    {{ activation_triggers_section.button_devices.entity_id | default([]) }}
  
  # Alternative turn-off devices
  effective_alternative_turn_off: >
    {{ alternative_turn_off_devices.entity_id | default([]) }}
  
  # Get current mode from input_select.home_mode
  current_mode: "{{ states('input_select.home_mode') | lower }}"
  
  # Calculate per-group brightness based on mode
  group_1_target_brightness: >
    {% if current_mode == 'away' %}
      {{ group_1_away_brightness }}
    {% elif current_mode == 'day' %}
      {{ group_1_day_brightness }}
    {% elif current_mode == 'evening' %}
      {{ group_1_evening_brightness }}
    {% elif current_mode == 'night' %}
      {{ group_1_night_brightness }}
    {% else %}
      {{ group_1_day_brightness }}
    {% endif %}
  
  group_2_target_brightness: >
    {% if current_mode == 'away' %}
      {{ group_2_away_brightness }}
    {% elif current_mode == 'day' %}
      {{ group_2_day_brightness }}
    {% elif current_mode == 'evening' %}
      {{ group_2_evening_brightness }}
    {% elif current_mode == 'night' %}
      {{ group_2_night_brightness }}
    {% else %}
      {{ group_2_day_brightness }}
    {% endif %}
  
  group_3_target_brightness: >
    {% if current_mode == 'away' %}
      {{ group_3_away_brightness }}
    {% elif current_mode == 'day' %}
      {{ group_3_day_brightness }}
    {% elif current_mode == 'evening' %}
      {{ group_3_evening_brightness }}
    {% elif current_mode == 'night' %}
      {{ group_3_night_brightness }}
    {% else %}
      {{ group_3_day_brightness }}
    {% endif %}
  
  # Calculate per-group color temperature based on mode
  group_1_target_color_temp: >
    {% if enable_color_temp %}
      {% if current_mode == 'away' %}
        {{ group_1_away_color_temp }}
      {% elif current_mode == 'day' %}
        {{ group_1_day_color_temp }}
      {% elif current_mode == 'evening' %}
        {{ group_1_evening_color_temp }}
      {% elif current_mode == 'night' %}
        {{ group_1_night_color_temp }}
      {% else %}
        {{ group_1_day_color_temp }}
      {% endif %}
    {% else %}
      4000
    {% endif %}
  
  group_2_target_color_temp: >
    {% if enable_color_temp %}
      {% if current_mode == 'away' %}
        {{ group_2_away_color_temp }}
      {% elif current_mode == 'day' %}
        {{ group_2_day_color_temp }}
      {% elif current_mode == 'evening' %}
        {{ group_2_evening_color_temp }}
      {% elif current_mode == 'night' %}
        {{ group_2_night_color_temp }}
      {% else %}
        {{ group_2_day_color_temp }}
      {% endif %}
    {% else %}
      3000
    {% endif %}
  
  group_3_target_color_temp: >
    {% if enable_color_temp %}
      {% if current_mode == 'away' %}
        {{ group_3_away_color_temp }}
      {% elif current_mode == 'day' %}
        {{ group_3_day_color_temp }}
      {% elif current_mode == 'evening' %}
        {{ group_3_evening_color_temp }}
      {% elif current_mode == 'night' %}
        {{ group_3_night_color_temp }}
      {% else %}
        {{ group_3_day_color_temp }}
      {% endif %}
    {% else %}
      2700
    {% endif %}
  
  # Calculate timeout based on mode and weekend
  motion_timeout: >
    {% set base_timeout = {
      'away': motion_timeout_away,
      'day': motion_timeout_day,
      'evening': motion_timeout_evening,
      'night': motion_timeout_night
    }[current_mode] | default(motion_timeout_day) %}
    {% if enable_weekend_settings and now().weekday() >= 5 %}
      {{ (base_timeout * weekend_timeout_multiplier) | round(1) }}
    {% else %}
      {{ base_timeout }}
    {% endif %}
  
  # Check if any motion sensors are active
  any_motion_active: >
    {{ expand(effective_motion_sensors) | selectattr('state', 'eq', 'on') | list | count > 0 }}
  
  # Check if all motion sensors are clear
  all_motion_clear: >
    {{ expand(effective_motion_sensors) | selectattr('state', 'eq', 'off') | list | count == (expand(effective_motion_sensors) | list | count) }}
  
  # Check if any contact sensors are open
  any_contact_open: >
    {{ expand(effective_contact_sensors) | selectattr('state', 'eq', 'on') | list | count > 0 }}
  
  # Check if all contact sensors are closed
  all_contacts_closed: >
    {{ expand(effective_contact_sensors) | selectattr('state', 'eq', 'off') | list | count == (expand(effective_contact_sensors) | list | count) }}
  
  # Check if any lights are currently on
  any_lights_on: >
    {{ expand(effective_lights) | selectattr('state', 'eq', 'on') | list | count > 0 }}
  
  # Check if all lights are currently off
  all_lights_off: >
    {{ expand(effective_lights) | selectattr('state', 'eq', 'off') | list | count == (expand(effective_lights) | list | count) }}
  
  # Check illuminance condition
  illuminance_ok: >
    {% if activation_options_section.enable_illuminance_control and activation_triggers_section.illuminance_sensor %}
      {{ states(activation_triggers_section.illuminance_sensor) | int(999) < activation_options_section.illuminance_threshold }}
    {% else %}
      true
    {% endif %}
  
  # Check TV condition
  tv_condition_ok: >
    {% if disable_when_tv_on and tv_media_player %}
      {{ not is_state(tv_media_player, 'playing') }}
    {% else %}
      true
    {% endif %}
  
  # Check sleep condition
  sleep_condition_ok: >
    {% if disable_when_sleeping and sleep_sensor %}
      {{ is_state(sleep_sensor, 'off') }}
    {% else %}
      true
    {% endif %}

trigger:
  # Motion sensor activation
  - platform: state
    entity_id: !input motion_sensors
    to: "on"
    id: motion_on
  
  # Motion sensor deactivation with timeout
  - platform: state
    entity_id: !input motion_sensors
    to: "off"
    for:
      minutes: "{{ motion_timeout }}"
    id: motion_timeout
  
  # Contact sensor activation
  - platform: state
    entity_id: !input contact_sensors
    to: "on"
    id: contact_open
  
  # Contact sensor deactivation
  - platform: state
    entity_id: !input contact_sensors
    to: "off"
    id: contact_closed
  
  # Button press events
  - platform: event
    event_type: 
      - zha_event
      - deconz_event
      - hue_event
      - xiaomi_aqara.click
    id: button_press
  
  # State changes for button devices
  - platform: state
    entity_id: !input button_devices
    id: button_state_change
  
  # Mode changes
  - platform: state
    entity_id: input_select.home_mode
    id: mode_change
  
  # Manual light changes (for override detection)
  - platform: state
    entity_id: "{{ effective_lights }}"
    id: manual_change
    context:
      user_id: null

condition:
  # Always allow the automation to run - conditions are handled in actions

action:
  - choose:
      # Motion activation
      - conditions:
          - condition: trigger
            id: motion_on
          - condition: template
            value_template: "{{ enable_motion_activation }}"
          - condition: template
            value_template: "{{ illuminance_ok }}"
          - condition: template
            value_template: "{{ tv_condition_ok }}"
          - condition: template
            value_template: "{{ sleep_condition_ok }}"
          - condition: or
            conditions:
              - condition: template
                value_template: "{{ activate_even_if_partially_on }}"
              - condition: template
                value_template: "{{ all_lights_off }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ enable_debug_logging }}"
            then:
              - service: system_log.write
                data:
                  message: "{{ effective_room_name }}: Motion detected, activating lights (Mode: {{ current_mode }})"
                  level: info
          
          - delay:
              seconds: "{{ activation_delay }}"
          
          # Activate Light Group 1
          - if:
              - condition: template
                value_template: "{{ effective_group_1_lights | length > 0 and group_1_target_brightness > 0 }}"
            then:
              - service: light.turn_on
                target:
                  entity_id: "{{ effective_group_1_lights }}"
                data:
                  brightness_pct: "{{ group_1_target_brightness }}"
                  color_temp_kelvin: "{{ group_1_target_color_temp if enable_color_temp else omit }}"
                  transition: "{{ fade_time }}"
          
          # Activate Light Group 2
          - if:
              - condition: template
                value_template: "{{ effective_group_2_lights | length > 0 and group_2_target_brightness > 0 }}"
            then:
              - service: light.turn_on
                target:
                  entity_id: "{{ effective_group_2_lights }}"
                data:
                  brightness_pct: "{{ group_2_target_brightness }}"
                  color_temp_kelvin: "{{ group_2_target_color_temp if enable_color_temp else omit }}"
                  transition: "{{ fade_time }}"
          
          # Activate Light Group 3
          - if:
              - condition: template
                value_template: "{{ effective_group_3_lights | length > 0 and group_3_target_brightness > 0 }}"
            then:
              - service: light.turn_on
                target:
                  entity_id: "{{ effective_group_3_lights }}"
                data:
                  brightness_pct: "{{ group_3_target_brightness }}"
                  color_temp_kelvin: "{{ group_3_target_color_temp if enable_color_temp else omit }}"
                  transition: "{{ fade_time }}"
          
          - if:
              - condition: template
                value_template: "{{ enable_occupancy_tracking }}"
            then:
              - event: room_lighting_activated
                event_data:
                  room: "{{ effective_room_name }}"
                  trigger: motion
                  mode: "{{ current_mode }}"
                  brightness: "{{ target_brightness }}"
      
      # Contact sensor activation
      - conditions:
          - condition: trigger
            id: contact_open
          - condition: template
            value_template: "{{ enable_contact_activation }}"
          - condition: template
            value_template: "{{ illuminance_ok }}"
          - condition: template
            value_template: "{{ tv_condition_ok }}"
          - condition: template
            value_template: "{{ sleep_condition_ok }}"
          - condition: or
            conditions:
              - condition: template
                value_template: "{{ activate_even_if_partially_on }}"
              - condition: template
                value_template: "{{ all_lights_off }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ enable_debug_logging }}"
            then:
              - service: system_log.write
                data:
                  message: "{{ effective_room_name }}: Contact opened, activating lights"
                  level: info
          
          - delay:
              seconds: "{{ activation_delay }}"
          
          - service: light.turn_on
            target:
              entity_id: "{{ effective_lights }}"
            data:
              brightness_pct: "{{ target_brightness }}"
              color_temp_kelvin: "{{ target_color_temp if enable_color_temp else omit }}"
              transition: "{{ fade_time }}"
      
      # Button activation
      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: button_press
              - condition: trigger
                id: button_state_change
          - condition: template
            value_template: "{{ enable_button_activation }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ enable_debug_logging }}"
            then:
              - service: system_log.write
                data:
                  message: "{{ effective_room_name }}: Button pressed, toggling lights"
                  level: info
          
          - service: light.toggle
            target:
              entity_id: "{{ effective_lights }}"
            data:
              brightness_pct: "{{ target_brightness }}"
              color_temp_kelvin: "{{ target_color_temp if enable_color_temp else omit }}"
              transition: "{{ fade_time }}"
      
      # Motion timeout (turn off)
      - conditions:
          - condition: trigger
            id: motion_timeout
          - condition: or
            conditions:
              - condition: template
                value_template: "{{ not require_all_motion_clear }}"
              - condition: template
                value_template: "{{ all_motion_clear }}"
          - condition: or
            conditions:
              - condition: template
                value_template: "{{ not require_contact_closed }}"
              - condition: template
                value_template: "{{ all_contacts_closed }}"
          - condition: or
            conditions:
              - condition: template
                value_template: "{{ turn_off_even_if_partially_off }}"
              - condition: template
                value_template: "{{ any_lights_on }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ enable_debug_logging }}"
            then:
              - service: system_log.write
                data:
                  message: "{{ effective_room_name }}: Motion timeout ({{ motion_timeout }} min), turning off lights"
                  level: info
          
          # Turn off main light groups
          - service: light.turn_off
            target:
              entity_id: "{{ effective_lights }}"
            data:
              transition: "{{ fade_time }}"
          
          # Turn off alternative devices
          - if:
              - condition: template
                value_template: "{{ effective_alternative_turn_off | length > 0 }}"
            then:
              - service: homeassistant.turn_off
                target:
                  entity_id: "{{ effective_alternative_turn_off }}"
          
          - if:
              - condition: template
                value_template: "{{ enable_occupancy_tracking }}"
            then:
              - event: room_lighting_deactivated
                event_data:
                  room: "{{ effective_room_name }}"
                  trigger: motion_timeout
                  timeout_minutes: "{{ motion_timeout }}"
      
      # Mode change adjustment
      - conditions:
          - condition: trigger
            id: mode_change
          - condition: template
            value_template: "{{ any_lights_on }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ enable_debug_logging }}"
            then:
              - service: system_log.write
                data:
                  message: "{{ effective_room_name }}: Mode changed to {{ current_mode }}, adjusting lights"
                  level: info
          
          - service: light.turn_on
            target:
              entity_id: "{{ effective_lights }}"
            data:
              brightness_pct: "{{ target_brightness }}"
              color_temp_kelvin: "{{ target_color_temp if enable_color_temp else omit }}"
              transition: "{{ fade_time }}"
      
      # Manual override detection
      - conditions:
          - condition: trigger
            id: manual_change
          - condition: template
            value_template: "{{ prevent_motion_override }}"
          - condition: template
            value_template: "{{ enable_debug_logging }}"
        sequence:
          - service: system_log.write
            data:
              message: "{{ effective_room_name }}: Manual light change detected, motion override may be prevented"
              level: info

mode: queued
max: 10
max_exceeded: silent
